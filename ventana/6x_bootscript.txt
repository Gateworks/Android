echo "Gateworks Ventana Android Boot script v1.01"

setenv bootargs enable_wait_mode=off
setenv nextcon 0
setenv bootargs $bootargs console=ttymxc1,115200 cma=384M consoleblank=0

if test -n "$tempfuse" ; then
	setenv bootargs $bootargs thermal.fusedata=$tempfuse
fi

# detect displays in the following priority: LVDS, HDMI
if test -n "$panel" ; then
else
  echo "Detecting displays..."
  i2c dev 2
  if i2c probe 0x04 ; then
	echo "  Freescale MXC-LVDS1 detected"
	setenv panel $panel "Hannstar-XGA"
  fi
  if i2c probe 0x49 ; then
	echo "  AUO G070VW01 with TSC2007 detected"
	setenv panel $panel "AUO-G070VW01"
  fi
  if hdmidet ; then
	echo "  HDMI detected"
	setenv panel $panel "HDMI"
  fi
fi

# configure displays
echo "Configuring kernel bootargs for display(s): $panel"
for p in ${panel}; do
  if itest.s "x${p}" == "xHannstar-XGA" ; then
	echo "  mxcfb${nextcon}: Freescale MXC-LVDS1"
	setenv bootargs $bootargs video=mxcfb${nextcon}:dev=ldb,bpp=32,LDB-XGA,if=RGB666
	if test "0" -eq $nextcon; then
		setenv fbmem "fbmem=20M"
	else
		setenv fbmem ${fbmem},20M
	fi
	setexpr nextcon $nextcon + 1

  elif itest.s "x${p}" == "xAUO-G070VW01" ; then
	echo "  mxcfb${nextcon}: AUO G070VW01"
	setenv bootargs $bootargs video=mxcfb${nextcon}:dev=ldb,bpp=32,LDB-WVGA,if=RGB666
	if test "0" -eq $nextcon; then
		setenv fbmem "fbmem=20M"
	else
		setenv fbmem ${fbmem},20M
	fi
	setexpr nextcon $nextcon + 1

  elif itest.s "x${p}" == "xHDMI" ; then
	test -n "$hdmi" || hdmi="1920x1280M@60"
	echo "  mxcfb${nextcon}: HDMI ($hdmi)"
	setenv bootargs $bootargs video=mxcfb${nextcon}:dev=hdmi,bpp=32,${hdmi},if=RGB24
	if test "0" -eq $nextcon; then
		setenv fbmem "fbmem=48M"
	else
		setenv fbmem ${fbmem},48M
	fi
	setexpr nextcon $nextcon + 1

  else
        echo "${p} not supported"
  fi
done

# disable remaining mxcfb devices
while test "4" -ne $nextcon ; do
	setenv bootargs $bootargs video=mxcfb${nextcon}:off
	setexpr nextcon $nextcon + 1
done

# boot disks (detect dtype by looking for kernel)
# in order of preference: usb/mmc/sata
test -n "$fs"    || fs=ext2
test -n "$disk"  || disk=0
if test -n "$dtype" ; then
	echo "booting from $dtype"
else
	echo "Detecting boot device (dtype)..."
	if ${fs}load usb ${disk}:1 10800000 boot/uImage ; then
		dtype=usb
	elif ${fs}load mmc ${disk}:1 10800000 boot/uImage ; then
		dtype=mmc
	elif ${fs}load sata ${disk}:1 10800000 boot/uImage ; then
		dtype=sata
	fi
	echo "dtype:$dtype"
fi
if test -n "$bootdev" ; then
	echo "Using androidboot.bootdev=$bootdev"
else
	if itest.s "x${dtype}" == "xmmc" ; then
		bootdev=mmcblk2
	else
		bootdev=sda
	fi
	echo "androidboot.bootdev=$bootdev"
fi

setenv bootargs $bootargs androidboot.hardware=freescale androidboot.bootdev=$bootdev androidboot.console=${console} ${extra}

${fs}load ${dtype} ${disk}:1 10800000 boot/uImage && ${fs}load ${dtype} ${disk}:1 18000000 boot/${fdt_file2} && bootm 10800000 - 18000000

echo "Error loading kernel image"
